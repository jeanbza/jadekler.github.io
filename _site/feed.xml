<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.1">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2020-10-12T18:47:56-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Jean de Klerk</title><subtitle>This is my personal website. The views represented here are my own, and do not represent my employer.</subtitle><entry><title type="html">Stubbing gRPC in Go</title><link href="http://localhost:4000/2020/10/08/stubbing-grpc.html" rel="alternate" type="text/html" title="Stubbing gRPC in Go" /><published>2020-10-08T15:55:23-06:00</published><updated>2020-10-08T15:55:23-06:00</updated><id>http://localhost:4000/2020/10/08/stubbing-grpc</id><content type="html" xml:base="http://localhost:4000/2020/10/08/stubbing-grpc.html">&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;

&lt;p&gt;I‚Äôve several times been met with the question, ‚ÄúHow do you stub gRPC in Go‚Äù?&lt;/p&gt;

&lt;p&gt;This is a short blog post about how to do that.&lt;/p&gt;

&lt;h1 id=&quot;mocking&quot;&gt;Mocking&lt;/h1&gt;

&lt;p&gt;Mocking gRPC clients is &lt;em&gt;super easy&lt;/em&gt; and doesn‚Äôt require a separate mocking
library. Given some proto with service,&lt;/p&gt;

&lt;div class=&quot;language-proto highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;service&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Greeter&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;rpc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SayHello&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;returns&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will generate a &lt;code class=&quot;highlighter-rouge&quot;&gt;greeter.pb.go&lt;/code&gt; with,&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GreeterClient&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;SayHello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That interface is all we need to mock away. Our code that communicates with
&lt;code class=&quot;highlighter-rouge&quot;&gt;Greeter&lt;/code&gt; will take the &lt;code class=&quot;highlighter-rouge&quot;&gt;GreeterClient&lt;/code&gt; interface, per usual dependency
injection. In our real code (&lt;code class=&quot;highlighter-rouge&quot;&gt;main.go&lt;/code&gt;, etc) we‚Äôll give it a real client,
and our tests we‚Äôll give it a fake client:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// Code that uses GreeterClient&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SomeService&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GreeterClient&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// Inject me with either a real GreeterClient or a fake one!&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewSomeService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SomeService&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SomeService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here‚Äôs our real code:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;greeterAddr&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;--greeterAddr=greeter:12345&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Dial&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GreeterAddr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;// Handle err.&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;someservice&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewSomeService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Use SomeService with real GreeterClient.&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And, here‚Äôs our test version using a fake GreeterClient for testing:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fakeGreeterClient&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fakeGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SayHello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fakeGreeterClient was not set up with a response - must set gc.sayHelloFn&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TestSomeService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;testing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requests&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fakeGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// Set up the fake greeter to return a canned message.&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;requests&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;requests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Record requests.&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Message&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;hello world&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;NewSomeService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Test serv.&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;requests&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Assert on expected requests.&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Simple! And, of course, &lt;code class=&quot;highlighter-rouge&quot;&gt;fakeGreeterClient&lt;/code&gt; can be more or less complicated:
perhaps it always returns the same thing (less complicated), or perhaps it tries
to mimic the behavior of the real &lt;code class=&quot;highlighter-rouge&quot;&gt;Greeter&lt;/code&gt; (more complicated).&lt;/p&gt;

&lt;h1 id=&quot;stubbing&quot;&gt;Stubbing&lt;/h1&gt;

&lt;p&gt;Sometimes we aren‚Äôt able to use dependency injection, but we &lt;em&gt;can&lt;/em&gt; choose which
connection we‚Äôre using. For example, this is the case with
&lt;a href=&quot;https://pkg.go.dev/cloud.google.com/go/pubsub&quot;&gt;cloud.google.com/go/pubsub&lt;/a&gt;,
whose &lt;a href=&quot;https://pkg.go.dev/cloud.google.com/go/pubsub#NewClient&quot;&gt;NewClient&lt;/a&gt; does
not allow passing the underlying &lt;a href=&quot;https://pkg.go.dev/google.golang.org/api/pubsub/v1&quot;&gt;google.golang.org/api/pubsub/v1 raw proto-generated client interface&lt;/a&gt; but &lt;a href=&quot;https://pkg.go.dev/google.golang.org/api/option#WithGRPCConn&quot;&gt;&lt;em&gt;does&lt;/em&gt; allow passing in a conn&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Another example where passing a mock is not good enough, and you have to rely
on some connection, is integration tests! For integration tests, you‚Äôd want your
real binary to talk to a &lt;code class=&quot;highlighter-rouge&quot;&gt;Greeter&lt;/code&gt; running locally, which you can
stub/set up/view interactions in the test itself. You‚Äôll want this stub
&lt;code class=&quot;highlighter-rouge&quot;&gt;Greeter&lt;/code&gt; to have some address like &lt;code class=&quot;highlighter-rouge&quot;&gt;localhost:12345&lt;/code&gt; that you can pass to your
binary through a flag, like &lt;code class=&quot;highlighter-rouge&quot;&gt;--greeterAddr=localhost:12345&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;These are just two small examples, but this problem of needing stubbing
capabilities beyond a simple interface mock comes up enough that it justifies
its own section.&lt;/p&gt;

&lt;p&gt;It turns out to be very similar to the above mocking strategy, with a few small
differences. Let‚Äôs dive in! We‚Äôll use the second example - the integration test -
though the principles apply equally to any opaque gRPC client situation.&lt;/p&gt;

&lt;p&gt;So, here‚Äôs our main from before, but we‚Äôre going to make it callable from our
test by sticking it in a non-main package:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;greeterAddr&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;--greeterAddr=greeter:12345&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;myapp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;myapp&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// Start starts the app. It is like main, but tests can call it.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Dial&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;// Handle err.&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;someservice&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewSomeService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Use SomeService with real GreeterClient.&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is one of &lt;em&gt;many&lt;/em&gt; ways to start an integration. It allows us to run &lt;code class=&quot;highlighter-rouge&quot;&gt;main&lt;/code&gt;
from our test, since &lt;code class=&quot;highlighter-rouge&quot;&gt;main&lt;/code&gt; itself is unexported and not run-able from a test.&lt;/p&gt;

&lt;p&gt;Sidenote: this method may seem hacky, but why? It‚Äôs just sticking your main into
another, callable method. It‚Äôs used by large projects &lt;a href=&quot;https://github.com/etcd-io/etcd/blob/00e49d0c10bb931f596d801d7368b5e0ae539fbd/main.go&quot;&gt;like etcd&lt;/a&gt; if you need further assurance. üôÇ&lt;/p&gt;

&lt;p&gt;There are other ways to test main. For example, you might spin up the binary by
executing shell using os.Cmd and the like. That‚Äôs fine! The same principles
apply.&lt;/p&gt;

&lt;p&gt;Anyways, we have a way to run &lt;code class=&quot;highlighter-rouge&quot;&gt;main&lt;/code&gt; - how do we get &lt;code class=&quot;highlighter-rouge&quot;&gt;main&lt;/code&gt; to talk to our stub?
We clearly can‚Äôt pass in a &lt;code class=&quot;highlighter-rouge&quot;&gt;GreeterClient&lt;/code&gt; interface. So, instead, we‚Äôll spin up
&lt;code class=&quot;highlighter-rouge&quot;&gt;Greeter&lt;/code&gt; as an in-memory server, and pass the in-memory server address to
&lt;code class=&quot;highlighter-rouge&quot;&gt;Start&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;net&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;google.golang.org/grpc&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeGreeterClient&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SayHello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fakeGreeterClient was not set up with a response - must set gc.sayHelloFn&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TestIntegration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;testing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;// Start FakeGreeterClient in an in-memory process.&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Listen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;tcp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;localhost:0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// IIRC 0 == &quot;first available port&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsrv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewServer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RegisterGreeterServer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gsrv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;fakeGreeterAddr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsrv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Serve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// We're in a goroutine - we can't t.Fatal/t.Error.&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;myapp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fakeGreeterAddr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// Test your app, which is now hooked up to FakeGreeterClient!&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ta-da! Very easy to start an in-memory gRPC fake.&lt;/p&gt;

&lt;h1 id=&quot;bonus-actually-testing-main-forreal&quot;&gt;Bonus: actually testing main, forreal&lt;/h1&gt;

&lt;p&gt;Ok, the above might be a bit arcane if you have the usual HTTP/gRPC API. You‚Äôre
now able to hook your app up to the fake in-memory server, but how do you
actually get your test to talk to &lt;em&gt;your&lt;/em&gt; app?&lt;/p&gt;

&lt;p&gt;However you want! But, we‚Äôll walk through one example.&lt;/p&gt;

&lt;p&gt;Imagine our app has some HTTP endpoints, and we want to send requests to them
from our test, and see that our app appropriately talks to &lt;code class=&quot;highlighter-rouge&quot;&gt;Greeter&lt;/code&gt; when those
endpoints get hit. Well, in order to do that we need an address that our test
can send requests to. Let‚Äôs make that happen!&lt;/p&gt;

&lt;p&gt;Let‚Äôs look at &lt;code class=&quot;highlighter-rouge&quot;&gt;main&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;Start&lt;/code&gt; again:&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;port&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;8080&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;the port this app will run on, ex --port=8080&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;greeterAddr&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;--greeterAddr=greeter:12345&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;flag&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;// When user kills this process, close the server.&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;myapp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;// Wait forever, until a user kills this process.&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;myapp&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// Start starts the app. Call Shutdown on the returned Server when done.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Server&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Dial&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeterAddr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;// Handle err.&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;someservice&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewSomeService&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Use SomeService with real GreeterClient.&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HandleFunc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/sayhello&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ResponseWriter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;serv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SayHello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;world&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    
    &lt;span class=&quot;n&quot;&gt;srv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Addr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;:%d&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;srv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ListenAndServe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ErrServerClosed&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;srv&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Mostly the same, except we now have an HTTP API. This is just an example - a
gRPC server would look similar.&lt;/p&gt;

&lt;p&gt;Onto the integration test!&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;net&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;google.golang.org/grpc&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FakeGreeterClient&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SayHello&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;CallOption&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HelloReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sayHelloFn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;in&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fakeGreeterClient was not set up with a response - must set gc.sayHelloFn&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TestIntegration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;testing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;// Start FakeGreeterClient in an in-memory process.&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FakeGreeterClient&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Listen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;tcp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;localhost:0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// IIRC 0 == &quot;first available port&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;gsrv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;grpc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewServer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;opts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;greeter&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RegisterGreeterServer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gsrv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;fakeGreeterAddr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gsrv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Serve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// We're in a goroutine - we can't t.Fatal/t.Error.&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;myappPort&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;openPort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;myappAddr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;localhost:%d&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;myappPort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;srv&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;myapp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;myappPort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fakeGreeterAddr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;srv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    
    &lt;span class=&quot;c&quot;&gt;// Test your app, which is now hooked up to FakeGreeterClient, by sending&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;// requests to myappAddr!&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// openPort returns an open port.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;openPort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;testing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Helper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Listen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;tcp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;:0&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;url&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Parse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatalf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;unable to parse a port from %s&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;l&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strconv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Atoi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;u&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h1&gt;

&lt;p&gt;Stubbing and mocking gRPC servers in Go is very easy, doesn‚Äôt require any
libraries, and obviates the need for pre-provided fakes/mocks/emulators/etc.&lt;/p&gt;</content><author><name></name></author><summary type="html">Introduction</summary></entry><entry><title type="html">Keeping Your Modules Compatible</title><link href="http://localhost:4000/2020/07/07/keeping-your-modules-compatible.html" rel="alternate" type="text/html" title="Keeping Your Modules Compatible" /><published>2020-07-07T15:55:23-06:00</published><updated>2020-07-07T15:55:23-06:00</updated><id>http://localhost:4000/2020/07/07/keeping-your-modules-compatible</id><content type="html" xml:base="http://localhost:4000/2020/07/07/keeping-your-modules-compatible.html">&lt;p&gt;Posted at &lt;a href=&quot;https://blog.golang.org/module-compatibility&quot;&gt;blog.golang.org/module-compatibility&lt;/a&gt;.&lt;/p&gt;</content><author><name></name></author><summary type="html">Posted at blog.golang.org/module-compatibility.</summary></entry><entry><title type="html">Binary Search Tree Runtime Complexities</title><link href="http://localhost:4000/2019/11/23/binary-search-tree-runtime-complexity.html" rel="alternate" type="text/html" title="Binary Search Tree Runtime Complexities" /><published>2019-11-23T14:55:23-07:00</published><updated>2019-11-23T14:55:23-07:00</updated><id>http://localhost:4000/2019/11/23/binary-search-tree-runtime-complexity</id><content type="html" xml:base="http://localhost:4000/2019/11/23/binary-search-tree-runtime-complexity.html">&lt;h1 id=&quot;introduction&quot;&gt;Introduction&lt;/h1&gt;

&lt;p&gt;I‚Äôve recently inundated myself with interview preparation. Along the way, I
thought a lot about how to intuit runtime complexities for various algorithms.
I thought that it might be nice to cement it all with an article - both for the
sake of others, as well as for my sake. This is the first article in that vein,
strictly dealing with binary search trees.&lt;/p&gt;

&lt;h1 id=&quot;terminology&quot;&gt;Terminology&lt;/h1&gt;

&lt;p&gt;Note: This article frequently uses the abbreviation BST to describe binary
search trees.&lt;/p&gt;

&lt;p&gt;Here are properties of trees that this article deals with:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Number of nodes in a tree is typically denoted &lt;code class=&quot;highlighter-rouge&quot;&gt;n&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;Height of a tree is typically denoted &lt;code class=&quot;highlighter-rouge&quot;&gt;k&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Binary_tree&quot;&gt;Complete&lt;/a&gt;: every level except
possibly the last is completely filled.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Binary_tree&quot;&gt;Full&lt;/a&gt;: every node has 0 or 2
children. This is a subset of complete: every full tree is a complete tree.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Binary_tree&quot;&gt;Balanced&lt;/a&gt;: the height of the left
and right subtrees of every node differ by at most 1. Using the root node as
our focus, we can intuit that any balanced tree has fairly uniform height.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Binary_search_tree&quot;&gt;Binary Search Tree&lt;/a&gt;:
A tree in which each element to the left of a node is guaranteed to be less,
and to the right guaranteed to be greater. &lt;em&gt;BSTs may not be balanced&lt;/em&gt;.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Red%E2%80%93black_tree&quot;&gt;Red-black Tree&lt;/a&gt;: A BST
that is balanced.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/AVL_tree&quot;&gt;AVL Tree&lt;/a&gt;: A BST that is balanced (in
a different way than red-black trees).&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Branching_factor&quot;&gt;Branching factor&lt;/a&gt;: The number
of children at each node.&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;searching-a-bst&quot;&gt;Searching a BST&lt;/h1&gt;

&lt;p&gt;Everyone knows that searching a binary search tree has runtime complexity
&lt;code class=&quot;highlighter-rouge&quot;&gt;O(logn)&lt;/code&gt;, right? ‚Ä¶right? Let‚Äôs take a second to tease apart some questions
from that assertion to see if we really understand what we mean when we say that:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Q: What is the &lt;a href=&quot;https://en.wikipedia.org/wiki/Logarithm&quot;&gt;base&lt;/a&gt; of the log?&lt;/p&gt;

    &lt;p&gt;A: Typically when we talk about the base of a log, we‚Äôre talking about 2 or 10.  In the case of a BST case it‚Äôs 2 (we‚Äôll dive into why that is shortly).&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Q: What does &lt;code class=&quot;highlighter-rouge&quot;&gt;n&lt;/code&gt; represent?&lt;/p&gt;

    &lt;p&gt;A: &lt;code class=&quot;highlighter-rouge&quot;&gt;n&lt;/code&gt; &lt;em&gt;usually&lt;/em&gt; means ‚Äúnumber of elements‚Äù. In this case, &lt;code class=&quot;highlighter-rouge&quot;&gt;n&lt;/code&gt; does mean that: or, another way to put that is ‚Äúnumber of nodes in the tree‚Äù.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;So, expanding &lt;code class=&quot;highlighter-rouge&quot;&gt;O(logn)&lt;/code&gt;, we have: &lt;code class=&quot;highlighter-rouge&quot;&gt;O(log2(&amp;lt;# nodes in tree&amp;gt;))&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Well, searching a BST is not strictly &lt;code class=&quot;highlighter-rouge&quot;&gt;O(log2(n))&lt;/code&gt;: it depends on whether the
BST is balanced or not. An unbalanced BST may be &lt;code class=&quot;highlighter-rouge&quot;&gt;O(n)&lt;/code&gt;. Let‚Äôs discover why by
exploring how the &lt;code class=&quot;highlighter-rouge&quot;&gt;log2&lt;/code&gt; comes about.&lt;/p&gt;

&lt;h1 id=&quot;logarithms-and-exponents&quot;&gt;Logarithms and exponents&lt;/h1&gt;

&lt;p&gt;Let‚Äôs look at the following &lt;em&gt;full&lt;/em&gt; binary tree:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/simple_complete.png&quot; alt=&quot;Full Binary Tree&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can tell the following about this tree:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;It has height &lt;code class=&quot;highlighter-rouge&quot;&gt;k=4&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;It has nodes &lt;code class=&quot;highlighter-rouge&quot;&gt;n=15&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The number of nodes is the sum of the nodes at each level. The number of nodes
at each level are powers of 2. So, at &lt;code class=&quot;highlighter-rouge&quot;&gt;k=4&lt;/code&gt; there are,&lt;/p&gt;

\[\begin{align*}
n=1+2+4+8 &amp;amp;&amp;amp; \text{The sum of the nodes at each level.} \\
n=2^0+2^1+2^2+2^3 &amp;amp;&amp;amp; \text{Represented in powers of 2.} \\
n=\sum\limits_{j=0}^{k-1} 2^j &amp;amp;&amp;amp; \text{Represented as a summation.} \\
\end{align*}\]

&lt;p&gt;The branching factor here is 2 - each node has 2 children. What if each child
had 7 children, or 9, or 21? Let‚Äôs re-write the summation with a generic
branching factor &lt;code class=&quot;highlighter-rouge&quot;&gt;b&lt;/code&gt;:&lt;/p&gt;

\[\begin{align*}
n=\sum\limits_{j=0}^{k-1} 2^j \\
n=\sum\limits_{j=0}^{k-1} b^j \\
\end{align*}\]

&lt;p&gt;Sums are a bit of nuisance. Let‚Äôs convert this sum into a discrete formula:&lt;/p&gt;

\[\begin{align*}
n=\sum\limits_{j=0}^{k-1} b^j \\
n=b^{k-1}+b^{k-2}+...+1 &amp;amp;&amp;amp; \text{Expanding the sum.} \\
n \cdot b=(b^{k-1}+b^{k-2}+...+1) \cdot b &amp;amp;&amp;amp; \text{Multiply by b.} \\
n \cdot b=b^k+b^{k-1}+...+b &amp;amp;&amp;amp; \text{All the exponents rise by 1.} \\
n \cdot b + 1=b^k+b^{k-1}+...+b+1 &amp;amp;&amp;amp; \text{Add 1 to each side.} \\
n \cdot b + 1=b^k + n &amp;amp;&amp;amp; \text{Note that we can use n for the right side.} \\
n \cdot b - n=b^k - 1 &amp;amp;&amp;amp; \text{Move n left; 1 right.} \\
n \cdot (b - 1)=b^k - 1 &amp;amp;&amp;amp; \text{Factor out n.} \\
n = \frac{b^k - 1}{b - 1} &amp;amp;&amp;amp; \text{Divide by n-1.} \\
\end{align*}\]

&lt;p&gt;Let‚Äôs test the formula by using &lt;code class=&quot;highlighter-rouge&quot;&gt;k=4&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;b=2&lt;/code&gt; again, which we think should
equal &lt;code class=&quot;highlighter-rouge&quot;&gt;n=15&lt;/code&gt;:&lt;/p&gt;

\[\begin{align*}
n=\frac{2^4-1}{2-1} \\
n=\frac{16-1}{1} \\
n=15 \\
\end{align*}\]

&lt;p&gt;What if we knew the amount of nodes, but not the height? We can rework the
formula we just came up with to give us height using number of nodes,&lt;/p&gt;

\[\begin{align*}
n=2^k-1 \\
n+1=2^k &amp;amp;&amp;amp; \text{Move 1 to the left.} \\
\log_2 {(n+1)}=\log_2 {(2^k)} &amp;amp;&amp;amp; \text{log2 both sides.} \\
\log_2 {(n+1)}=k \cdot \log_2 2 &amp;amp;&amp;amp; \text{Power rule.} \\
\log_2 {(n+1)}=k &amp;amp;&amp;amp; \text{Identity rule.} \\
k=\log_2 {(n+1)}
\end{align*}\]

&lt;h1 id=&quot;back-to-binary-search-trees&quot;&gt;Back to binary search trees&lt;/h1&gt;

&lt;p&gt;How can we apply this knowledge? Consider again our original topic of a binary
search tree: one property of a BST is that a search operation requires no
backtracking. That is: the path to a node always going to go at most to a leaf
node - it never reaches a leaf and then has to backtrack and try a different
choice at a former node.&lt;/p&gt;

&lt;p&gt;If the BST is unbalanced, the worst case time complexity to search for a value
is &lt;code class=&quot;highlighter-rouge&quot;&gt;O(n)&lt;/code&gt;. We can easily show that this is the case with the following tree:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/left_bst.png&quot; alt=&quot;Left BST&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This BST is heavily weighted to the right. To search for the value 109, we‚Äôd have to
look at each of the &lt;code class=&quot;highlighter-rouge&quot;&gt;n=15&lt;/code&gt; elements. That is: the worst case time complexity is
&lt;code class=&quot;highlighter-rouge&quot;&gt;O(n)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;What if this BST were balanced, instead?&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/balanced_bst.png&quot; alt=&quot;Balanced BST&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now, to search for &lt;em&gt;any&lt;/em&gt; value in the BST, the maximum depth we‚Äôd need to
traverse is &lt;code class=&quot;highlighter-rouge&quot;&gt;k&lt;/code&gt;. We know that &lt;code class=&quot;highlighter-rouge&quot;&gt;k=log2(n)&lt;/code&gt;, so we can say that the big-O runtime
complexity in terms of &lt;code class=&quot;highlighter-rouge&quot;&gt;n&lt;/code&gt; is &lt;code class=&quot;highlighter-rouge&quot;&gt;O(log2(n))&lt;/code&gt;.&lt;/p&gt;

&lt;h1 id=&quot;in-conclusion&quot;&gt;In conclusion&lt;/h1&gt;

&lt;p&gt;There are at most &lt;code class=&quot;highlighter-rouge&quot;&gt;n=(b^k - 1)/(b - 1)&lt;/code&gt; nodes in any tree with height &lt;code class=&quot;highlighter-rouge&quot;&gt;k&lt;/code&gt; and
branching factor &lt;code class=&quot;highlighter-rouge&quot;&gt;b&lt;/code&gt;. In a binary tree, that simplifies to &lt;code class=&quot;highlighter-rouge&quot;&gt;n=2^k-1&lt;/code&gt;, and can
be re-written in terms of height as &lt;code class=&quot;highlighter-rouge&quot;&gt;k=log2(n+1)&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;To conclude our original question: binary search trees don‚Äôt guarantee
&lt;code class=&quot;highlighter-rouge&quot;&gt;O(log2(n))&lt;/code&gt; search: &lt;em&gt;balanced&lt;/em&gt; BSTs do.&lt;/p&gt;

&lt;p&gt;In a future article we‚Äôll look at &lt;a href=&quot;https://en.wikipedia.org/wiki/Heap_(data_structure)&quot;&gt;Heap&lt;/a&gt;
runtime complexity, and how memoization affects that. In some other future
article we‚Äôll look at backtracking and permutation runtime complexities.&lt;/p&gt;

&lt;script type=&quot;text/javascript&quot; async=&quot;&quot; src=&quot;/assets/MathJax-2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;&gt;
&lt;/script&gt;

&lt;script type=&quot;text/x-mathjax-config&quot;&gt;
    MathJax.Hub.Config({
      extensions: [
        &quot;MathMenu.js&quot;,
        &quot;MathZoom.js&quot;,
        &quot;AssistiveMML.js&quot;
      ],
      jax: [&quot;input/TeX&quot;, &quot;output/CommonHTML&quot;],
      TeX: {
        extensions: [
          &quot;AMSmath.js&quot;,
          &quot;AMSsymbols.js&quot;,
          &quot;noErrors.js&quot;,
          &quot;noUndefined.js&quot;,
        ]
      }
    });
  &lt;/script&gt;</content><author><name></name></author><summary type="html">Introduction</summary></entry><entry><title type="html">Go Modules: v2 and Beyond</title><link href="http://localhost:4000/2019/11/07/v2-modules.html" rel="alternate" type="text/html" title="Go Modules: v2 and Beyond" /><published>2019-11-07T14:55:23-07:00</published><updated>2019-11-07T14:55:23-07:00</updated><id>http://localhost:4000/2019/11/07/v2-modules</id><content type="html" xml:base="http://localhost:4000/2019/11/07/v2-modules.html">&lt;p&gt;Posted at &lt;a href=&quot;https://blog.golang.org/v2-go-modules&quot;&gt;blog.golang.org&lt;/a&gt;.&lt;/p&gt;</content><author><name></name></author><summary type="html">Posted at blog.golang.org.</summary></entry><entry><title type="html">Docker in Docker</title><link href="http://localhost:4000/2019/11/05/docker-in-docker.html" rel="alternate" type="text/html" title="Docker in Docker" /><published>2019-11-05T14:55:23-07:00</published><updated>2019-11-05T14:55:23-07:00</updated><id>http://localhost:4000/2019/11/05/docker-in-docker</id><content type="html" xml:base="http://localhost:4000/2019/11/05/docker-in-docker.html">&lt;h1 id=&quot;i-got-beef-with-all-yalls-articles&quot;&gt;I got beef with all y‚Äôalls articles&lt;/h1&gt;

&lt;p&gt;Oh look, another docker-in-docker post. How original. Ok, I get it, there are
many of these out there. Here‚Äôs my beef with all the ones I could find at 1am
last night: when people talk about docker-in-docker, they‚Äôre actually talking
about docker-as-a-service [2] [3] [4] [5] [7] [8] [9] (or, the worse ‚Äújust
mount docker from your own filesystem‚Äù [1] [4] [6] [7]).&lt;/p&gt;

&lt;p&gt;That is: docker-in-docker is when you run a container, log into it, and are able
to run &lt;code class=&quot;highlighter-rouge&quot;&gt;docker&lt;/code&gt;. Docker-as-a-service is when you run a container with &lt;code class=&quot;highlighter-rouge&quot;&gt;dockerd&lt;/code&gt;
and then linking other containers into that container, which themselves run
&lt;code class=&quot;highlighter-rouge&quot;&gt;docker&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Ok, yeah, I made up those arbitrary distinctions. But, this is my blog, so I&lt;/em&gt;
&lt;em&gt;can do what I want! :)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The big difference is that I can do both on my local laptop, but the latter
requires extraorinarily more effort to actually stick in a cloud since most
automated ‚Äúrun a container in the cloud‚Äù services have no idea wtf you‚Äôre
talking about trying to link containers and shit. We‚Äôre just here to run your
one, single container dude.&lt;/p&gt;

&lt;h1 id=&quot;ok-how-do-you-actually-do-this&quot;&gt;Ok how do you actually do this&lt;/h1&gt;

&lt;p&gt;Easy solution:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ docker run --privileged -it docker:dind /bin/sh
/ # dockerd-entrypoint.sh &amp;amp;
[...]
/ # docker ps
error during connect: Get http://docker:2375/v1.40/containers/json: dial tcp: lookup docker on 192.168.65.1:53: no such host
/ # # womp womp
/ # unset DOCKER_HOST
/ # docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
/ # # huzzah!
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, yeah, &lt;code class=&quot;highlighter-rouge&quot;&gt;unset DOCKER_HOST&lt;/code&gt;. What‚Äôs happening here is that &lt;code class=&quot;highlighter-rouge&quot;&gt;DOCKER_HOST&lt;/code&gt; is
being set to &lt;code class=&quot;highlighter-rouge&quot;&gt;tcp://docker:2375&lt;/code&gt;, but we want to unset that to make it use the
unix socket. See more explanation at &lt;a href=&quot;https://github.com/docker-library/docker/issues/200&quot;&gt;https://github.com/docker-library/docker/issues/200&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&quot;petty-citations&quot;&gt;Petty citations&lt;/h1&gt;

&lt;p&gt;1: https://docs.gocd.org/current/gocd_on_kubernetes/docker_workflows.html#docker-in-docker-dind&lt;/p&gt;

&lt;p&gt;2: https://hub.docker.com/_/docker&lt;/p&gt;

&lt;p&gt;3: https://docs.gitlab.com/ee/ci/docker/using_docker_build.html&lt;/p&gt;

&lt;p&gt;4: https://itnext.io/docker-in-docker-521958d34efd&lt;/p&gt;

&lt;p&gt;5: https://sreeninet.wordpress.com/2016/12/23/docker-in-docker-and-play-with-docker/&lt;/p&gt;

&lt;p&gt;6: https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/&lt;/p&gt;

&lt;p&gt;7: http://blog.teracy.com/2017/09/11/how-to-use-docker-in-docker-dind-and-docker-outside-of-docker-dood-for-local-ci-testing/&lt;/p&gt;

&lt;p&gt;8: https://stackoverflow.com/questions/45928958/how-to-run-docker-container-inside-docker-dind&lt;/p&gt;

&lt;p&gt;9: https://discourse.drone.io/t/build-and-test-docker-images-with-dind/1808&lt;/p&gt;</content><author><name></name></author><summary type="html">I got beef with all y‚Äôalls articles</summary></entry><entry><title type="html">Bad Times Initializing With Append</title><link href="http://localhost:4000/2019/10/23/init-with-append.html" rel="alternate" type="text/html" title="Bad Times Initializing With Append" /><published>2019-10-23T15:55:23-06:00</published><updated>2019-10-23T15:55:23-06:00</updated><id>http://localhost:4000/2019/10/23/init-with-append</id><content type="html" xml:base="http://localhost:4000/2019/10/23/init-with-append.html">&lt;p&gt;I recently found out as part of &lt;a href=&quot;https://go-review.googlesource.com/c/tools/+/184357&quot;&gt;a code review&lt;/a&gt;
that initializing variables with append is, under some circumstances, A
Terrible Idea. This post briefly explores what can happen when you do that,
the underlying reason these things are happening, and how to avoid it.&lt;/p&gt;

&lt;h1 id=&quot;a-modest-test&quot;&gt;A modest test&lt;/h1&gt;

&lt;p&gt;Consider &lt;a href=&quot;https://play.golang.org/p/3v_fgJLmtgO&quot;&gt;the following program&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;one&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;two&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;three&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;four&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;five&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;six&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;seven&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;b&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What do you think the value of a, b, and c should be?&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;a [one two three four five]
b [one two three four five six]
c [one two three four five seven]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That make sense! Now consider &lt;a href=&quot;https://play.golang.org/p/6EShDJVSgfo&quot;&gt;this very similar program&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;one&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;two&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;three&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;four&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;five&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;six&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;seven&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;b&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do you think the values are any different? If you guessed or assumed there‚Äôs no
difference - as I did in my codereview - you would be mistaken. The values are,&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;a [one two three four five]
b [one two three four five seven]
c [one two three four five seven]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;what-the-heck&quot;&gt;What the heck?&lt;/h1&gt;

&lt;p&gt;Note: this section assumes you understand that slices are composed of a
reference to an underlying array, a length, and a capacity. See more details at
https://blog.golang.org/go-slices-usage-and-internals.&lt;/p&gt;

&lt;p&gt;The difference is that the first array was initialized by &lt;code class=&quot;highlighter-rouge&quot;&gt;[]string{...}&lt;/code&gt;, and
the second by &lt;code class=&quot;highlighter-rouge&quot;&gt;append(...)&lt;/code&gt;. Why does that make a difference, though, and what‚Äôs
going on under the hood?&lt;/p&gt;

&lt;p&gt;Well, if we inspect the length and capacity of &lt;code class=&quot;highlighter-rouge&quot;&gt;a&lt;/code&gt; with
&lt;code class=&quot;highlighter-rouge&quot;&gt;fmt.Println(&quot;len:&quot;, len(a), &quot;cap:&quot;, cap(a))&lt;/code&gt; in both cases, we‚Äôll see that
under the hood there‚Äôs another small difference:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# program 1 - []string{...}
len: 5 cap: 5
# program 2 - append(...)
len: 5 cap: 8
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When we use &lt;code class=&quot;highlighter-rouge&quot;&gt;[]string{...}&lt;/code&gt;, the resultant slice‚Äôs length and capacity are
equal. However, when we perform &lt;code class=&quot;highlighter-rouge&quot;&gt;append([]string{...}, &quot;something&quot;)&lt;/code&gt;, we are
guaranteed to get a slice with spare capacity, since the append must immediately
grow the array (the inner slice has exact length=capacity - no space remaining).&lt;/p&gt;

&lt;p&gt;So, in the first program, both times that we appended the length already equaled
the capacity, and a new underlying array had to be created for each append. That
meant that both appends added a value to separate underlying arrays.&lt;/p&gt;

&lt;p&gt;However, in the second program, there was room in the underlying array - length
was less than capacity. So, instead of creating new arrays for both appends,
both appends operated on the same underlying array. When we assigned
&lt;code class=&quot;highlighter-rouge&quot;&gt;b := append(a, ...)&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;b&lt;/code&gt; got its own &lt;code class=&quot;highlighter-rouge&quot;&gt;len: 6, cap: 8&lt;/code&gt; counters but used the
array underlying &lt;code class=&quot;highlighter-rouge&quot;&gt;a&lt;/code&gt;. Similarly, when we assigned &lt;code class=&quot;highlighter-rouge&quot;&gt;c := append(a, ...)&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;c&lt;/code&gt;
got its own &lt;code class=&quot;highlighter-rouge&quot;&gt;len: 6, cap: 8&lt;/code&gt; and used the array underlying &lt;code class=&quot;highlighter-rouge&quot;&gt;a&lt;/code&gt; also. Since &lt;code class=&quot;highlighter-rouge&quot;&gt;b&lt;/code&gt;
and &lt;code class=&quot;highlighter-rouge&quot;&gt;c&lt;/code&gt; share an underlying array, but &lt;em&gt;do not&lt;/em&gt; share their counters, that means
they both tried to assign a value to index &lt;code class=&quot;highlighter-rouge&quot;&gt;5&lt;/code&gt;.&lt;/p&gt;

&lt;h1 id=&quot;how-to-solve-this&quot;&gt;How to solve this?&lt;/h1&gt;

&lt;p&gt;Here are some other ways you could accomplish the same thing:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;If you know the values ahead of time, do &lt;code class=&quot;highlighter-rouge&quot;&gt;a := []string{...}&lt;/code&gt;.&lt;/li&gt;
  &lt;li&gt;If you know the capacity ahead of time, do &lt;code class=&quot;highlighter-rouge&quot;&gt;a := make([]string, 0, cap)&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;Copy https://github.com/golang/go/wiki/SliceTricks#copy.&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;when-is-this-not-a-problem&quot;&gt;When is this not a problem?&lt;/h1&gt;

&lt;p&gt;The key piece above is that &lt;code class=&quot;highlighter-rouge&quot;&gt;b&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;c&lt;/code&gt; are the result of appending to &lt;code class=&quot;highlighter-rouge&quot;&gt;a&lt;/code&gt;. If
&lt;code class=&quot;highlighter-rouge&quot;&gt;a&lt;/code&gt; is only ever going to be appended to itself (a very common use of slices),
the problem won‚Äôt occur, since there will always only ever be one length counter
to maintain. With only one length counter, there‚Äôs no room for two appends
accidentally assigning to the same index.&lt;/p&gt;</content><author><name></name></author><summary type="html">I recently found out as part of a code review that initializing variables with append is, under some circumstances, A Terrible Idea. This post briefly explores what can happen when you do that, the underlying reason these things are happening, and how to avoid it.</summary></entry><entry><title type="html">Reflecting on two years at Google</title><link href="http://localhost:4000/2019/09/01/reflecting-on-two-years-at-google.html" rel="alternate" type="text/html" title="Reflecting on two years at Google" /><published>2019-09-01T15:55:23-06:00</published><updated>2019-09-01T15:55:23-06:00</updated><id>http://localhost:4000/2019/09/01/reflecting-on-two-years-at-google</id><content type="html" xml:base="http://localhost:4000/2019/09/01/reflecting-on-two-years-at-google.html">&lt;p&gt;I had meant to write a &lt;em&gt;‚ÄúReflecting on one year at Google‚Äù&lt;/em&gt; post earlier this
year, but it kept getting put off until suddenly I realized that it would be
better to just cut my losses and skip to the second year post.&lt;/p&gt;

&lt;p&gt;Then, when I got into it, I realized that a lot of my experience with Google
was from the outside: failing repeatedly trying to get in. So, after writing a
bunch about that, I decided to create two posts: &lt;em&gt;&lt;a href=&quot;/2019/09/01/reflecting-on-interviewing-at-google&quot;&gt;‚ÄúReflecting on interviewing
at Google‚Äù&lt;/a&gt;&lt;/em&gt; and this post.&lt;/p&gt;

&lt;p&gt;Now, with all that out the way, I‚Äôm finally read to really dig in and start some
serious reflection and introspection.&lt;/p&gt;

&lt;p&gt;Background note: I started at Google in late 2017. I moved from Colorado to
California (San Francisco bay area) for the job, and moved back to Colorado
in early 2018 (keeping the job, but working from Boulder, Colorado).&lt;/p&gt;

&lt;h1 id=&quot;small-steps&quot;&gt;Small steps&lt;/h1&gt;

&lt;p&gt;Starting at Google was unlike any other job. Most jobs I‚Äôve had, and heard
about, followed a pattern of a 2-week break-in period followed by a few
months contributing but still kind-of trying to get caught up, followed by
proficiency, and at some point later you might lead a team.&lt;/p&gt;

&lt;p&gt;Google was very much not like that. You start by attending at 2 week
orientation with the other ~400-700 people in your ‚ÄúNoogler‚Äù class. Yes,
&lt;em&gt;hundreds&lt;/em&gt; of people - mostly engineers - start at Google every two weeks.
On one campus. More on other campuses. Mind blown.&lt;/p&gt;

&lt;p&gt;The first two weeks are spent in lectures and seminars repeatedly having your
sense of scale and proportion obliterated, being exposed to various systems and teams
within the company, being taught by senior engineers how to use some of these
systems, and generally being taught how to teach yourself.&lt;/p&gt;

&lt;p&gt;In your third week you‚Äôre ready to meet your team. Your team introduces you to
a ‚Äústarter project‚Äù: a small project in a well-understood area that you can use
to feel good about yourself, and hopefully along the way learn how to actually
start writing and releasing code. You‚Äôre given something like a month to finish
this.&lt;/p&gt;

&lt;p&gt;So, it takes &lt;em&gt;6 weeks after you start&lt;/em&gt; before you‚Äôre actually ready to look at
real code. And, beyond that, most teams will only expect you to be a
fully independent, contributing team member somewhere around month 6 to 9.&lt;/p&gt;

&lt;h1 id=&quot;inch-by-inch&quot;&gt;Inch by inch&lt;/h1&gt;

&lt;p&gt;My first actually-useful piece of code I submitted, if I recall correctly, was
a code sample that showed developers how to use the Pub/Sub client library in
a certain way.&lt;/p&gt;

&lt;p&gt;All code at Google goes through a process called ‚Äúcode review‚Äù, where code
changes (or additions, deletions) get ‚Äúproposed‚Äù and reviewed by colleagues,
who either Yea, Nay, or ask for changes. Code review is a fairly common practice
in software engineering, though the implementation varies a lot by company. At
most companies, code review usually something like 30 minutes to 2 days per code
change. Code reviews at most companies are typically fairly high-level, and tend
to concern themselves with broad design or nit-picky things like code style.&lt;/p&gt;

&lt;p&gt;That first change I proposed took something like &lt;em&gt;two weeks&lt;/em&gt; to get through
code review. I learned more about Go and code design during that code review
than I‚Äôd experienced the entire past year leading up to that point (which is
not that high of a bar, if you know my prior experiences, but still). It was
brutal. My code was picked apart; it was analyzed line-by-line, and then
block-by-block, and then file-by-file. It wasn‚Äôt malicious, though: code review
comments were statements of fact, or impartial queries, rather than jabs and
one-ups. They were, ‚ÄúThis can be more performant like so: |example|. And,
here‚Äôs why: |reason|.‚Äù, not ‚ÄúThis is terrible. Do it this way: |example|.‚Äù.&lt;/p&gt;

&lt;p&gt;After years of stagnation in my career at that point it was so wonderful to
be learning again, from people with a deep wealth of knowledge and
experience. I was hooked.&lt;/p&gt;

&lt;p&gt;The next year was a lot of this. I got better by inches: by treating each code
review as a learning opportunity; by diving into problems I had no business
being in; by pushing myself, over, and over, and over, to become better.&lt;/p&gt;

&lt;p&gt;Looking back, I was getting better: the scope of problems continually increased;
the code reviews went from weeks to hours or days, from everything-under-the-sun
is wrong to fairly-subtle suggestions. I was slowly transitioning from a student
that needed hand-holding, and didn‚Äôt provide much in return, to a colleague that
accepted and gave equally (or, closer to equal).&lt;/p&gt;

&lt;h1 id=&quot;metre-by-unhealthy-metre&quot;&gt;Metre by unhealthy metre&lt;/h1&gt;

&lt;p&gt;My intense passion for interesting problems and self-improvement finally had an
outlet, and that outlet was unbounded in scope. Worse: it rewarded the effort
I put in: despite my increasing weariness, the scope of my work constantly
increased (by my own volition); my personal reviews were stellar; and my
projects were almost universally a success.&lt;/p&gt;

&lt;p&gt;I didn‚Äôt realize until fairly late that I was slowly grinding myself down to the
bone. I was working 10, 12, or 14 hour days, and often would work on weekends.
I took my frustrations and problems home rather than leaving them at work; they
were compounded with my increasing dislike of California.&lt;/p&gt;

&lt;p&gt;I ended up getting most of the way through that first year before realizing some
things were very bad. For the first time in my life, I recognized signs of
depression. Some combination of a too-intense work schedule, longing for my
old friends and outdoor-focused lifestyle in Colorado, and relationship problems
were causing me to be deeply unhappy.&lt;/p&gt;

&lt;p&gt;I won‚Äôt get into that part too much. The long story short is that I had a bit of
a break down and decided I needed to move back to Colorado, Google or no Google.
Thankfully, my department was and is fantastic and thoroughly supported me, and
offered me my job at the Colorado campus with a standard cost-of-living pay reduction.&lt;/p&gt;

&lt;p&gt;I moved back to Colorado in early 2018 with the same job.&lt;/p&gt;

&lt;h1 id=&quot;on-to-the-other-side&quot;&gt;On to the other side&lt;/h1&gt;

&lt;p&gt;The year taught me a lot about my limits to an extent that‚Äôs hard to put into
words. I‚Äôve learned how to spot signs of too much stress, healthy coping
mechanisms, and how to set boundaries. I‚Äôve learned a lot about what I value,
and the type of life I want for myself. And, it‚Äôs helped me refine the kind of
person I want to be: hard-working and respected in my career, yes, but also a kind
friend with space in my life to help others; a well-rounded individual with lots
of time spent outdoors; a good partner. It‚Äôs hard not to wish I had had these
skills going into the job. It would have saved a lot of hardship for myself and
my relationship at the time. I suppose the best you can do is try to learn from
hardship, though, and try to become better for it.&lt;/p&gt;

&lt;p&gt;In the last year I‚Äôve committed myself to a healthy balance of passion for my
job and all the rest that matter to me: loving relationships with friends and
family; spending time in nature; sports and exercise; hobbies like reading and
taking french lessons; and progressing my ‚Äúadult‚Äù life with things like buying
a house and building a local community.&lt;/p&gt;

&lt;p&gt;My work hasn‚Äôt suffered hardly as much as I thought it would. Working 7 to
8 hours a day has made me be a lot more efficient with my time: I cancel or
decline a lot more meetings; I don‚Äôt take hour-long lunches with colleagues;
I don‚Äôt do a lot of after-work events; I delegate a lot more rather than
‚Äúsuperhero‚Äù all the work myself. And, the reprecussions never came: my lessened
throughput was celebrated by my manager and team as mental health successes,
rather than the disappointment I was subconsiously bracing myself for.&lt;/p&gt;

&lt;p&gt;The outcome is a much healthier, happier day-to-day, week-to-week. I once
again find self-value in things outside of work; I have a robust and healthy
support system of friends and family; I progress myself in sports and hobbies
so that stalls or failures at work are diminished in impact by successes
elsewhere.&lt;/p&gt;

&lt;h1 id=&quot;keeping-perspective&quot;&gt;Keeping perspective&lt;/h1&gt;

&lt;p&gt;I‚Äôve had the privilege and honour of working with incredible minds, who have
universally been kind and willing to teach. I‚Äôve sat in rooms with people that
have invented entire languages, network protocols, and algorithms for systems
at scale. I‚Äôve had my opinions heard and sincerely considered by these people,
and had the opportunity to learn from them. I‚Äôve had the opportunity to lead;
to design; to mentor; and to teach. I‚Äôve accomplished and learned more (in my
own eyes) in these two years than my entire career before this.&lt;/p&gt;

&lt;p&gt;I‚Äôve also had the honour of having incredible managers and directors. I have
felt since day one that I was a valued member of a team; that my opinions held
weight; that I was supported in whatever I decided was best for myself, even if
that meant leaving the company or my team.&lt;/p&gt;

&lt;p&gt;I work on things that I find really, really cool: building a performance
benchmarking pipelines and improving client library performance; defining the
client-side retry strategy for all of Google Cloud; improving Google Cloud
reliability with throttling and load shedding; building important and complex
features into libraries; working on the HTTP/2 transport in gRPC; and loads
more. Moreover, I‚Äôve been given a lot of freedom in choosing the kinds of things
I work on, and being encouraged to go find new problems that we‚Äôre not aware of
yet.&lt;/p&gt;

&lt;p&gt;I‚Äôve had opportunities to travel around the world, meeting developers, working
with amazing engineers, and giving talks on technical topics. And at home, we
are given a tremendous amount of benefits, too: classes, food,
classes about making food (seriously), gyms, fun events, clubs, and more.&lt;/p&gt;

&lt;p&gt;It‚Äôs a good place to work. It‚Äôs an intense place to work, and you have to be
very careful not to let it burn you up, but it is a good place to work. I
don‚Äôt see myself working anywhere else for the foreseeable future.&lt;/p&gt;</content><author><name></name></author><summary type="html">I had meant to write a ‚ÄúReflecting on one year at Google‚Äù post earlier this year, but it kept getting put off until suddenly I realized that it would be better to just cut my losses and skip to the second year post.</summary></entry><entry><title type="html">Reflecting on interviewing at Google</title><link href="http://localhost:4000/2019/09/01/reflecting-on-interviewing-at-google.html" rel="alternate" type="text/html" title="Reflecting on interviewing at Google" /><published>2019-09-01T15:55:23-06:00</published><updated>2019-09-01T15:55:23-06:00</updated><id>http://localhost:4000/2019/09/01/reflecting-on-interviewing-at-google</id><content type="html" xml:base="http://localhost:4000/2019/09/01/reflecting-on-interviewing-at-google.html">&lt;p&gt;Disclaimer: This document makes statements and gives advice about interviewing
at Google. This is &lt;em&gt;not at all&lt;/em&gt; an official accounting of what it‚Äôs like to
interview at Google. This is entirely my own interpration, likely riddled with
inaccuracies to the extent that a Googler in recruitment would probably develop
a migraine reading this. If you‚Äôd like the official word, check out
careers.google.com or talk to a recruiter.&lt;/p&gt;

&lt;p&gt;Foreword: SWE is an abbreviation for Software Engineer and is often pronounced
‚Äúswee‚Äù.&lt;/p&gt;

&lt;h1 id=&quot;aiming-high&quot;&gt;Aiming high&lt;/h1&gt;

&lt;p&gt;For me, the ultimate goal has always been Google.&lt;/p&gt;

&lt;p&gt;I began programming during Ms. Roszko‚Äôs Computer Science I course in my
sophomore year of high school. I graduated university seven years later with
degrees in Math and Computer Science. Sometime between then, I had convinced
myself that the pinnacle of a career in computer science was a job at Google.&lt;/p&gt;

&lt;p&gt;I‚Äôm not sure why. Perhaps the infamously hard interview process, which seemed to
accept only the best of the best. Perhaps the reputably sky-high salaries. Or,
most likely it was that the work was that special kind of interesting and
challenging that all engineers yearn for. The kind of work that you are trained
to do in university - implementing red-black trees; modifying Djikstra‚Äôs
algorithm to suit some arcane need; or coming up with some novel algorithm. The
kind of work that hardly any other job seemed to offer; certainly not my
internships up to that point, which all centered around writing websites in some
form or another.&lt;/p&gt;

&lt;p&gt;I got my first interview at Google during my senior year of university and
promptly failed it.&lt;/p&gt;

&lt;h1 id=&quot;interviews-and-exams&quot;&gt;Interviews and exams&lt;/h1&gt;

&lt;p&gt;In a traditional company, the programming interview process goes something like
this:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;You write a compelling one-page resume, trying to condense your work
experience whilst using all buzz words that might be Ctrl-F‚Äôed by a recruiter.&lt;/li&gt;
  &lt;li&gt;You apply for a specific job on a specific team.&lt;/li&gt;
  &lt;li&gt;Recruiting team Yea/Nay depending on whether you have the right mix of
buzzwords and years experience.&lt;/li&gt;
  &lt;li&gt;If they Yea, you get a phone call talking about the job and the interview
process.&lt;/li&gt;
  &lt;li&gt;Then, you usually do one phone interview with an engineer or manager which
is designed to vet out the incompetent and clearly poor fits.&lt;/li&gt;
  &lt;li&gt;If you make it past this, you‚Äôre usually invited onsite for something like a
half or full day. It‚Äôs usually comprised of you being asked about things on
your resume, about how you would tackle imaginary problems, and to
solve contrived problems - or perhaps even solve a real problem. All the while
you‚Äôre usually evaluated on some fuzzy criteria of ‚Äúintelligence‚Äù and
‚Äúactually knows wtf they are doing‚Äù and ‚Äúwould i want to work with this
person‚Äù.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;It‚Äôs a very imperfect process, but it seems to work OK-ish for a lot of
companies.&lt;/p&gt;

&lt;p&gt;Google‚Äôs is much more academic, exam-like. It looks something like this:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;You write a resume that will be scanned for minimum qualifications and then
largely ignored.&lt;/li&gt;
  &lt;li&gt;You apply for a role (ex SWE) with no idea of which team you might be placed in.&lt;/li&gt;
  &lt;li&gt;Phone interview with recruiter which lays out the next steps.&lt;/li&gt;
  &lt;li&gt;45m technical phone interview with a randomly-selected SWE. You‚Äôre writing
code straight into Google Docs. The interview question is usually hard but
not mind-blowingly hard. The format is exam-like: you‚Äôre posed a single
question and then asked to solve it. If you succeed, the question is altered
slightly to be harder, and then you‚Äôre asked to alter your solution to solve
the new version of the question.&lt;/li&gt;
  &lt;li&gt;Next, you may be asked to perform another 45m technical phone interview if
your last one was borderline.&lt;/li&gt;
  &lt;li&gt;Next, you make it to the onsite. Huzzah! The onsite is 5 in-person 45m
technical interviews at a Google campus. Each of the 45m interviews is once
again exam-like, and usually a bit harder than the phone interview. You‚Äôre
being asked questions you‚Äôd expect on a computer science exam: answers usually
involve things like Minimum Spanning Trees, Heaps, clever bit manipulations,
and so on. The solution is ‚Äúcoded up‚Äù on the whiteboard. Each interviewer is
selected largely at random from a pool of SWE interviewers.&lt;/li&gt;
  &lt;li&gt;Finally, all data from interviews is collated and sent to a hiring committee.&lt;/li&gt;
  &lt;li&gt;If the hiring committee Yeas you, you work with the recruiter to pick a team.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Most people take somewhere between 2 weeks to 3 months to study before
attempting the interview (exam).&lt;/p&gt;

&lt;p&gt;If you fail anywhere in the process, you must wait one year before being allowed
to repeat the process.&lt;/p&gt;

&lt;h1 id=&quot;failing-and-failure&quot;&gt;Failing and failure&lt;/h1&gt;

&lt;p&gt;My first failure was in 2013 - my senior year of university.&lt;/p&gt;

&lt;p&gt;After that failure, I became determined to get better - to &lt;em&gt;be&lt;/em&gt; better. I had
a minimum bar for myself and a singular goal I could focus on. One year later in
2014 I re-took the exam and failed again. I did so again in 2015, again in 2016,
and finally in 2017 I made it through. Each year I spent around 2 months
preparing for the interview.&lt;/p&gt;

&lt;p&gt;I believe two things changed in ways that helped me get through the interview.&lt;/p&gt;

&lt;p&gt;The first is that after failing the SWE interview in 2016 the recruiter
suggested I try interviewing for a Developer Programs Engineer (DPE) role. The DPE role was
described as a more open-source and developers focused role, as opposed to the
only-software-all-the-time focused SWE role. It was still in engineering, and
still involved programming, but the interview was slightly different.&lt;/p&gt;

&lt;p&gt;I was all for it, figuring that my several years of open source contribution at
that point might give me an edge, and that if I didn‚Äôt like it I could probably
switch to a SWE role internally.&lt;/p&gt;

&lt;p&gt;So, after accepting the idea, I was immediately fast-tracked into an
onsite DPE interview a few weeks after that failure. I promptly failed the DPE
interview, too. But! The interviewer said ‚ÄúYou were close!‚Äù. So, that was nice.&lt;/p&gt;

&lt;p&gt;The interview didn‚Äôt differ much, except that one or two of the onsite questions
was geared towards open source. A question that I remember, for example, is to
explain in detail how dockerization works from the kernel up to the user facing
pieces. The remaining three or four questions were still the usual solve-a-hard-problem
whiteboard types.&lt;/p&gt;

&lt;p&gt;In 2017, I gave the DPE interview another go and succeeded. The open source parts
of the interview were focused on Go - a programming language I had been using
since 2013, and had been active in the community for some time at that point.
It helped that I was very familiar with the subject at that point.&lt;/p&gt;

&lt;p&gt;The other part that changed is my method to preparing for interviews.&lt;/p&gt;

&lt;h1 id=&quot;interview-preparation&quot;&gt;Interview preparation&lt;/h1&gt;

&lt;p&gt;There‚Äôs about 6 ways you can prepare for a technical interview:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Memorize algorithms and data structures.&lt;/li&gt;
  &lt;li&gt;Solve contrived problems on leetcode.com / hackerrank.com / &lt;em&gt;Cracking The
Coding Interview&lt;/em&gt;.&lt;/li&gt;
  &lt;li&gt;Read computer science books (such as Skiena‚Äôs &lt;em&gt;Algorithm Design Manual&lt;/em&gt;).&lt;/li&gt;
  &lt;li&gt;Take a computer science course (or, be a student already taking one).&lt;/li&gt;
  &lt;li&gt;Perform real or mock interviews.&lt;/li&gt;
  &lt;li&gt;Do hard, Computer-Science-y things regularly (like, as part of your job).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For the majority of my interviews during my career, I had focused on the first
two: memorization and solving contrived problems. In retrospect, these did
little for me except make me more anxious. I had trouble retaining the knowledge
for more than a day or two: without putting any of it into actual practice, it
seemed to just evaporate.&lt;/p&gt;

&lt;p&gt;I‚Äôd also been taking interviews at companies since graduating - even when
happily employed. I figured the longer you go without interviewing, the more
nerve-racking it becomes, and the more out of practice you become, so why not
interview once or twice a year just to keep in the swing of it. This helped
me be more at-ease during interviews, but ultimately I was lacking mastery of
the subjects.&lt;/p&gt;

&lt;p&gt;Note: an ideal situation is that your day-to-day job involves the kind of
hard problems that you‚Äôd find in a Google interview. That‚Äôs a pipe dream for
most developers, though: an overwhelming majority of software development is
pretty banal implementation of web applications, mobile applications, or some
piping-of-data in the backend applications. Loads of engineering, surely, but
not really Computer Science.&lt;/p&gt;

&lt;p&gt;In 2017 I started a Computer Science Master‚Äôs program through Georgia Institute
of Technology (Georgia Tech). It was at the time a novel online course, well
reputed for being extremely rigorous despite being online, and offering an
actual Master of Science degree. (It has since become very popular, and has
instigated a wave of similar programs from other top universities.)&lt;/p&gt;

&lt;p&gt;The classes I took were Computer Vision, Building Problem-Solving AIs, and
Computer Networking. Each class had intensive projects that forced me to learn
and re-learn large parts of Math and Computer Science. They were also extremely
well taught, and very, very fun. The AI course, for example, had you build a
game-playing AI that you could pit against other classmates‚Äô AIs.&lt;/p&gt;

&lt;p&gt;This type of atmosphere allowed for experimentation and competition, and
rewarded both broad use of many Computer Science topics as well as deep dives.
It was for me the perfect way to get back in the academic mindset; to master
Computer Science and math topics; and ultimately to prepare for the interview.&lt;/p&gt;

&lt;p&gt;As the interview process began again that year, I supplemented it with basic
familiarity with a wide number of algorithms taken from books, as well as a few
mock interviews.&lt;/p&gt;

&lt;p&gt;It seemed to work: I got an offer sometime around October of 2017.&lt;/p&gt;

&lt;p&gt;Or, maybe they got sick and tired of me interviewing five years running. :)
There‚Äôs something to be said for stubborn will!&lt;/p&gt;

&lt;h1 id=&quot;repeating-the-miracle&quot;&gt;Repeating the miracle&lt;/h1&gt;

&lt;p&gt;If I had to do it all again, or give advice to someone starting the process,
here‚Äôs what I‚Äôd suggest:&lt;/p&gt;

&lt;p&gt;First, don‚Äôt pin all your hopes on Google. The acceptance rate is less than
Harvard by an order of magnitude: the numbers aren‚Äôt really in your favour.
Once you make peace with that, the rest comes a lot easier.&lt;/p&gt;

&lt;p&gt;The good news is that if you do convince yourself to study for Google, you will
&lt;em&gt;crush&lt;/em&gt; every other interview you take. Google requires such an obscenely high
level of preparation that it makes other interviews look like child play. So,
apply to Google, but also look for other jobs that would interest you: you will
never be more prepared to interview for them.&lt;/p&gt;

&lt;p&gt;Another piece of good news is that the difference between a rejection and a
success is mostly the preparation that goes into the candidate. There is
certainly some luck involved, and being naturally gifted always helps, but
mostly practice - smart practice - is what sets good candidates apart from
the rest.&lt;/p&gt;

&lt;p&gt;One more piece of good news is that Google goes to great lengths to make the
process as unbiased as possible. That means, you‚Äôre not on the hook for trying
to buddy up to the person interviewing you. It also means that the differences
between you and the person interviewing you - be it cultural background, or
viewpoints, or any other differentiating factor - are totally irrelevant. You‚Äôre
only being evaluated on your objective performance.&lt;/p&gt;

&lt;p&gt;So, in conclusion, I think that the real secret sauce is choosing a study
schedule that fits healthily into your life - rather than obsessing about
getting &lt;em&gt;this one job&lt;/em&gt; - and choosing a method of study that works for you.
Every person learns differently, and retains knowledge differently. Some of my
colleagues swear by working on practice problems, whilst I strongly prefer the
approach of taking courses and completing homework / projects.&lt;/p&gt;

&lt;p&gt;Consider the list of interview prepation techniques above and do some
introspection about how you learn best. And, if you can, try to orient your
job around interesting problems that push you to learn, rather than staying
in your comfort zone.&lt;/p&gt;</content><author><name></name></author><summary type="html">Disclaimer: This document makes statements and gives advice about interviewing at Google. This is not at all an official accounting of what it‚Äôs like to interview at Google. This is entirely my own interpration, likely riddled with inaccuracies to the extent that a Googler in recruitment would probably develop a migraine reading this. If you‚Äôd like the official word, check out careers.google.com or talk to a recruiter.</summary></entry><entry><title type="html">Migrating to Go Modules</title><link href="http://localhost:4000/2019/08/21/migrating-to-go-modules.html" rel="alternate" type="text/html" title="Migrating to Go Modules" /><published>2019-08-21T15:55:23-06:00</published><updated>2019-08-21T15:55:23-06:00</updated><id>http://localhost:4000/2019/08/21/migrating-to-go-modules</id><content type="html" xml:base="http://localhost:4000/2019/08/21/migrating-to-go-modules.html">&lt;p&gt;Posted at &lt;a href=&quot;https://blog.golang.org/migrating-to-go-modules&quot;&gt;blog.golang.org&lt;/a&gt;.&lt;/p&gt;</content><author><name></name></author><summary type="html">Posted at blog.golang.org.</summary></entry><entry><title type="html">Designing CRUD operations in Go</title><link href="http://localhost:4000/2019/06/08/designing-crud-operations-in-go.html" rel="alternate" type="text/html" title="Designing CRUD operations in Go" /><published>2019-06-08T15:55:23-06:00</published><updated>2019-06-08T15:55:23-06:00</updated><id>http://localhost:4000/2019/06/08/designing-crud-operations-in-go</id><content type="html" xml:base="http://localhost:4000/2019/06/08/designing-crud-operations-in-go.html">&lt;p&gt;This post is intended to provide some insight into the considerations that
go into adding CRUD operations in a Go client library.&lt;/p&gt;

&lt;h2 id=&quot;the-problem-ambiguity&quot;&gt;The Problem: Ambiguity&lt;/h2&gt;

&lt;p&gt;Every time we add a new create or update RPC - &lt;code class=&quot;highlighter-rouge&quot;&gt;CreateFoo&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;UpdateFoo&lt;/code&gt; - that
takes parameters, we have to ask the questions:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Is it possible to perform a delete a parameter when updating Foo?&lt;/li&gt;
  &lt;li&gt;How should users ignore that parameter when updating Foo?&lt;/li&gt;
  &lt;li&gt;How should users delete that parameter when updating Foo?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Consider the following RPC:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;message FooUpdateRequest {
  google.protobuf.Duration ttl = 1;        // When set to 0, deletes TTL.
  google.protobuf.Duration expiration = 2; // When set to 0, deletes expiration.
}

service Foo {
  rpc UpdateFoo(FooUpdateRequest) returns (SomeResponse)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Building a manual layer wrapper around this might look very similar:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;type FooConfigToUpdate struct {
  Ttl        time.Duration
  Expiration time.Duration
}

func (f *Foo) Update(ctx context.Context, cfg *FooConfigToUpdate) error {
  // ...
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This seems fairly innocuous, but consider those questions again:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Is it possible to perform a delete a parameter when updating Foo?
A: Yes, both parameters in the .proto definition mention that 0 is used as a delete.&lt;/li&gt;
  &lt;li&gt;How should users ignore that parameter when updating Foo?
A: Set it to time.Duration(0).&lt;/li&gt;
  &lt;li&gt;How should users delete that parameter when updating Foo?
A: Uhh‚Ä¶ also set it to time.Duration(0)?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;As you can see, there‚Äôs currently no way to distinguish between Delete and
Ignore. That is, if a user passes:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;f.Update(ctx, &amp;amp;foopkg.FooConfigToUpdate{Expiration: 5 * time.Second})
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It‚Äôs clear that we need to update Expiration to 5s, but what do we do with ttl?
Its default value is &lt;code class=&quot;highlighter-rouge&quot;&gt;time.Duration(0)&lt;/code&gt; - do we delete it, or ignore it?&lt;/p&gt;

&lt;p&gt;We need a way to get around this. Broadly, there are three options we use in client libraries:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Sentinel values.&lt;/li&gt;
  &lt;li&gt;Pointers.&lt;/li&gt;
  &lt;li&gt;Optionals.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;sentinel-values&quot;&gt;Sentinel Values&lt;/h2&gt;

&lt;p&gt;Sentinel values are basically special values that signal to the client library
to perform special logic. For example, consider:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;var NeverExpire time.Duration = -1 * time.Second
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No user would ever specify -1s as an expiration value, so the library picks that
value as its sentinel. Then, any time the library sees -1s, it knows this is the
special value used to indicate ‚Äúdelete‚Äù.&lt;/p&gt;

&lt;p&gt;If the empty value is passed, the library ignores the operation. If the user
passes the sentinel value, the library performs the delete. A user uses the
sentinel to delete as such:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;f.Update(ctx, &amp;amp;foopkg.FooConfigToUpdate{Expiration: foopkg.NeverExpire})
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;pointers&quot;&gt;Pointers&lt;/h2&gt;

&lt;p&gt;When using pointers, we automatically resolve ambiguity, because beside the
empty value we now also have the nil value.&lt;/p&gt;

&lt;p&gt;The nil value is taken as ‚Äúignore this‚Äù (unspecified), and the empty value is
taken as ‚Äúdelete this‚Äù.&lt;/p&gt;

&lt;p&gt;A user uses the empty value to delete as such:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;f.Update(ctx, &amp;amp;foopkg.FooConfigToUpdate{Expiration: &amp;amp;time.Duration(0)})
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;optionals&quot;&gt;Optionals&lt;/h2&gt;

&lt;p&gt;Optionals are a Java concept. Without involving pointers, they add an
additional ‚Äúset or unset‚Äù parameter to a value in a similar way that pointers
are set or nil.&lt;/p&gt;

&lt;p&gt;Unlike Java, however, optionals are not part of the stdlib. In
&lt;code class=&quot;highlighter-rouge&quot;&gt;cloud.google.com/go&lt;/code&gt;, we‚Äôve created a very light wrapper around &lt;code class=&quot;highlighter-rouge&quot;&gt;interface{}&lt;/code&gt;
to implement optional types. Since they‚Äôre light wrappers around &lt;code class=&quot;highlighter-rouge&quot;&gt;interface{}&lt;/code&gt;,
values are nil-able.&lt;/p&gt;

&lt;p&gt;Like pointers, the nil value is taken as ‚Äúignore this‚Äù (unspecified), and the
empty value is taken as ‚Äúdelete this‚Äù.&lt;/p&gt;

&lt;p&gt;A user uses the empty value to delete as such:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;f.Update(ctx, &amp;amp;foopkg.FooConfigToUpdate{Expiration: time.Duration(0)})
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;choosing-the-right-solution&quot;&gt;Choosing The Right Solution&lt;/h2&gt;

&lt;p&gt;There are downsides to each solution:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Sentinels add to the API surface, and reduce the range of values users can
use. They are not described by the type system, like pointers: users have to
read docs to find out how to use them. Finally, they may surprise users using
the reserved value without knowing that they are.&lt;/li&gt;
  &lt;li&gt;Pointers only work on types - ints, strings, bools, and other primitives
become quite burdensome to use. Furthermore, pointers can‚Äôt be added in a
backwards-compatible fashion, since they change the signature of a
parameter/method.&lt;/li&gt;
  &lt;li&gt;Optionals are untyped (since they‚Äôre wrappers around interface{}), and not
idiomatic Go.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;On the other hand, the advantages to each solution:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Sentinels can be added in a backwards-compatible fashion, since they don‚Äôt
change the signature of a parameter/method.&lt;/li&gt;
  &lt;li&gt;Pointers are very idiomatic to Go, widely used, and their semantics are
encoded in the type system, making them very easy and obvious to use.&lt;/li&gt;
  &lt;li&gt;Optionals can be added (but not removed) in a backwards-compatible fashion,
since their untyped nature is compatible with an pre-existing inputs supplied
by the user.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Sentinels should generally be avoided, since we try to minimize API surface
additions. They are commonly used in ‚Äúuh oh‚Äù moments where we have to go amend
a stable client‚Äôs API surface in which the to-be-fixed portion is already
released.&lt;/p&gt;

&lt;p&gt;Pointers are generally the preferred choice but fall short on primitive types,
and aren‚Äôt backwards-compatible. Optionals are fairly widely used, too.&lt;/p&gt;

&lt;p&gt;In general, it‚Äôs best to investigate the client you‚Äôre working on and focus on
consistency of choice. Ideally, all clients would be consistent with each other, too.&lt;/p&gt;

&lt;h2 id=&quot;a-note-on--experimental&quot;&gt;A Note On // Experimental&lt;/h2&gt;

&lt;p&gt;Note that if a part of the API surface is marked experimental, the above notes
on backwards compatibility don‚Äôt apply. Therefore, if you‚Äôre adding to an API
surface and not sure how it‚Äôll evolve over time, opt to add the
&lt;code class=&quot;highlighter-rouge&quot;&gt;// Experimental&lt;/code&gt; tag:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;// It is EXPERIMENTAL and subject to change or removal without notice.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><summary type="html">This post is intended to provide some insight into the considerations that go into adding CRUD operations in a Go client library.</summary></entry></feed>